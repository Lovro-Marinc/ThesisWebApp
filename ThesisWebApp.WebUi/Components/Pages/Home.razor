@page "/"
@using ThesisWebApp.WebUi.State
@inject IProjectRepository ProjectRepo
@inject SelectionService ss
@implements IDisposable

<h2>Current project</h2>
@if (currentProject != null)
{
    <div class="current-project">
        Selected: @currentProject.ProjectID
    </div>
}

<div class="project-list">
    @foreach (var project in availableProjects)
    {
        <div class="project-item @(project.ProjectID == currentProject?.ProjectID ? "selected" : "")"
             @onclick="() => SelectProject(project)">
            @project.ProjectID
        </div>
    }
</div>

@code {
    private List<Project> availableProjects = new();
    private Project? currentProject;

    protected override async Task OnInitializedAsync()
    {
        availableProjects = await ProjectRepo.GetAllAsync();
        currentProject = ss.SelectedProject;

        // Subscribe to changes
        ss.OnSelectedProjectChanged += OnProjectChanged;
    }

    private void SelectProject(Project project)
    {
        ss.SetSelectedProject(project);
    }

    private async void OnProjectChanged()
    {
        await InvokeAsync(() =>
        {
            currentProject = ss.SelectedProject;
            StateHasChanged();
        });
    
    }

    public void Dispose()
    {
        // Important: unsubscribe to prevent memory leaks
        ss.OnSelectedProjectChanged -= OnProjectChanged;
    }
}